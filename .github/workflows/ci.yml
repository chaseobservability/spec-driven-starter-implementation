name: ci
on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install
        run: pnpm i
      - name: Validate pinned spec and OpenAPI
        run: pnpm spec:validate
      - name: Validate flows parse
        run: |
          python - <<'PY'
          import glob, yaml
          for p in glob.glob("spec/starter-spec-v*/flows/*.yaml"):
            yaml.safe_load(open(p,'r',encoding='utf-8'))
            print("OK flow:", p)
          PY
      - name: Ensure governance files exist
        run: |
          test -f ROADMAP.md
          test -f CONTRIBUTING.md
          test -f RELEASE_CHECKLIST.md
          test -f docs/ENGINEERING_GUIDELINES.md
          test -f CHANGELOG.md

      - name: Ensure harness files exist
        run: |
          test -f AGENTS.md
          test -f SDD_STARTER_PACK_CONTRACT.md
          test -f docs/index.md
          test -f docs/architecture/index.md
          test -f docs/product-specs/index.md
          test -f docs/references/index.md
          test -f docs/exec-plans/tech-debt-tracker.md
          test -d docs/exec-plans/active
          test -d docs/exec-plans/completed

      - name: Harness lint
        run: python3 tooling/harness_lint.py

      - name: Evaluate flow contract coverage
        run: python3 tooling/flow_contract_eval.py
